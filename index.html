<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Excess Mortality Analysis</title>
  <link rel="stylesheet" href="./assets/style.css">
  <script defer src="./assets/libs/plotly.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script defer src="./assets/script.js?v=2"></script>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; connect-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;">
  <meta name="description" content="Interactive plot viewer for cumulative excess ASMR comparisons with data loading and export capabilities.">
</head>
<body>
  <header class="container">
  </header>

  <main class="container">
    <div class="title-bubble">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 250px;">
          <h2 style="margin: 0 0 8px 0;">Excess Mortality Analysis</h2>
          <ul class="description" style="margin: 0;">
            <li><a href="#section1" class="section-link">Section 1: Cumulative Excess ASMR</a></li>
            <li><a href="#section2" class="section-link">Section 2: Structural Factors</a></li>
            <li><a href="#section3" class="section-link">Section 3: Policy Factors</a></li>
            <li><a href="#section4" class="section-link">Section 4: Counterfactuals</a></li>
            <li><a href="#section5" class="section-link">Section 5: Method Notes</a></li>
          </ul>
        </div>
        <button id="modeToggleBtn" class="filter-btn" style="font-weight: 600; flex-shrink: 0;">
          Switch to Basic Mode
        </button>
      </div>
    </div>
    <section id="permanentPlot" class="chart-card">
      <h3 id="section1" style="margin-top: 16px; margin-bottom: 12px;">Section 1: Cumulative Excess ASMR</h3>
      <div class="chart-controls">
        <div class="control-row advanced-only">
          <label>Data File
            <select id="dataFileSelect">
              <option value="20162019qpr.txt" selected>20162019qpr.txt (2016-2019 fixed baseline)</option>
              <option value="20152019qpr.txt">20152019qpr.txt (2015-2019 fixed baseline)</option>
              <option value="20142019qpr.txt">20142019qpr.txt (2014-2019 fixed baseline)</option>
              <option value="20132019qpr.txt">20132019qpr.txt (2013-2019 fixed baseline)</option>
              <option value="20122019qpr.txt">20122019qpr.txt (2012-2019 fixed baseline)</option>
              <option value="20112019qpr.txt">20112019qpr.txt (2011-2019 fixed baseline)</option>
              <option value="20102019qpr.txt">20102019qpr.txt (2010-2019 fixed baseline)</option>
              <option value="QPR-RSMEmin.txt">QPR-RSMEmin.txt (RMSE-minimized baselines)</option>
            </select>
          </label>
          <button id="loadDataFileBtn" class="filter-btn" title="Load selected data file">Load</button>
        </div>
        <div class="control-row">
          <label>Aggregation
            <select id="permanentPlotAggregation">
              <option value="weekly" selected>Weekly (original)</option>
              <option value="quarterly">Quarterly average</option>
              <option value="6monthly">6-monthly average</option>
              <option value="annual">Annual average</option>
            </select>
          </label>
        </div>
        <div class="control-row">
          <div class="filter-buttons">
            <button id="filterAll" class="filter-btn active">All</button>
            <button id="filterCluster1" class="filter-btn advanced-only">Cluster 1</button>
            <button id="filterCluster2" class="filter-btn advanced-only">Cluster 2</button>
            <button id="filterCluster3" class="filter-btn advanced-only">Cluster 3</button>
            <button id="filterCluster4" class="filter-btn advanced-only">Cluster 4</button>
          </div>
          <label style="margin-left: 12px;">Add country
            <input id="addCountryInput" list="countryList" placeholder="Type to search..." />
            <datalist id="countryList"></datalist>
          </label>
          <button id="addCountryBtn" class="filter-btn" title="Add country to current selection">+</button>
        </div>
      </div>
      <div id="permanentPlotChart" class="chart"></div>
      <div id="permanentPlotTraceDetails" class="trace-details" style="display: none;">
        <h3>Selected Trace Details</h3>
        <div id="permanentPlotTraceInfo"></div>
        <div id="permanentPlotASMRChart" class="chart"></div>
      </div>
      
      <div id="summaryTable"></div>
      
      <div id="scatterplotSection" class="chart-card" style="margin-top: 20px;">
        <h3 id="section2" style="margin-top: 0; margin-bottom: 12px;">Section 2: Structural Factors</h3>
        <h2 style="display: none;">Average ASMR vs Cumulative Excess (follows table sorting)</h2>
        <div id="scatterplotXAxisTable" style="margin-bottom: 20px; display: none;"></div>
        <div class="chart-controls">
          <div class="control-row">
            <label>Year
              <select id="scatterplotYearSelect">
                <option value="2025" selected>2025 (cumulative)</option>
                <option value="2025-isolated">2025 (isolated)</option>
                <option value="2024">2024 (cumulative)</option>
                <option value="2024-isolated">2024 (isolated)</option>
                <option value="2023">2023 (cumulative)</option>
                <option value="2023-isolated">2023 (isolated)</option>
                <option value="2022">2022 (cumulative)</option>
                <option value="2022-isolated">2022 (isolated)</option>
                <option value="2021">2021 (cumulative)</option>
                <option value="2021-isolated">2021 (isolated)</option>
              </select>
            </label>
            <label>X Axis
              <select id="asmrYearRange">
                <option value="2019" selected>2019 ASMR</option>
                <option value="gdp">GDP (Nominal) per Capita</option>
                <option value="gini">Inequality (GINI)</option>
                <option value="poverty">Poverty (% living below line)</option>
                <option value="health_expenditure">Health Expenditure (%GDP)</option>
              </select>
            </label>
            <div class="advanced-only">
              <label style="flex-direction: row; align-items: center; gap: 6px;">
                <input type="checkbox" id="logXAxis" checked>
                <span>Log X Axis</span>
              </label>
              <label style="flex-direction: row; align-items: center; gap: 6px;">
                <input type="checkbox" id="logYAxis" checked>
                <span>Log Y Axis</span>
              </label>
            </div>
          </div>
        </div>
        <div id="scatterplotChart" class="chart"></div>
        <div id="residualsTable"></div>
        
        <div id="residualResidualSection" class="advanced-only">
          <h3 style="margin-top: 30px;">Residual vs Residual</h3>
          <div class="chart-controls">
            <div class="control-row">
              <label>Year
                <select id="residualYearSelect">
                  <option value="2025" selected>2025 (cumulative)</option>
                  <option value="2025-isolated">2025 (isolated)</option>
                  <option value="2024">2024 (cumulative)</option>
                  <option value="2024-isolated">2024 (isolated)</option>
                  <option value="2023">2023 (cumulative)</option>
                  <option value="2023-isolated">2023 (isolated)</option>
                  <option value="2022">2022 (cumulative)</option>
                  <option value="2022-isolated">2022 (isolated)</option>
                  <option value="2021">2021 (cumulative)</option>
                  <option value="2021-isolated">2021 (isolated)</option>
                </select>
              </label>
              <label>X Axis Factor
                <select id="residualXAxisFactor">
                  <option value="2019" selected>2019 ASMR</option>
                  <option value="gdp">GDP (Nominal) per Capita</option>
                  <option value="gini">Inequality (GINI)</option>
                  <option value="poverty">Poverty (% living below line)</option>
                  <option value="health_expenditure">Health Expenditure (%GDP)</option>
                </select>
              </label>
              <label>Y Axis Factor
                <select id="residualYAxisFactor">
                  <option value="2019">2019 ASMR</option>
                  <option value="gdp" selected>GDP (Nominal) per Capita</option>
                  <option value="gini">Inequality (GINI)</option>
                  <option value="poverty">Poverty (% living below line)</option>
                  <option value="health_expenditure">Health Expenditure (%GDP)</option>
                </select>
              </label>
            </div>
          </div>
          <div id="residualsScatterplotChart" class="chart"></div>
        </div>
        
        <h3 style="margin-top: 30px; display: none;">2019 ASMR vs GDP (Nominal) per Capita</h3>
        <div id="asmrGdpTable" style="display: none;"></div>
        <div id="asmrGdpScatterplotChart" class="chart" style="display: none;"></div>
        
        <h3 style="margin-top: 30px;">Cumulative Excess vs Structural Vulnerability Index</h3>
        <div class="chart-controls">
          <div class="control-row">
            <label>Year
              <select id="compositeIndexYearSelect">
                <option value="2025" selected>2025 (cumulative)</option>
                <option value="2025-isolated">2025 (isolated)</option>
                <option value="2024">2024 (cumulative)</option>
                <option value="2024-isolated">2024 (isolated)</option>
                <option value="2023">2023 (cumulative)</option>
                <option value="2023-isolated">2023 (isolated)</option>
                <option value="2022">2022 (cumulative)</option>
                <option value="2022-isolated">2022 (isolated)</option>
                <option value="2021">2021 (cumulative)</option>
                <option value="2021-isolated">2021 (isolated)</option>
              </select>
            </label>
            <label class="advanced-only">Index Mode
              <select id="compositeIndexModeSelect">
                <option value="dynamic">Dynamic</option>
                <option value="2025-fixed" selected>2025 Fixed</option>
                <option value="2024-fixed">2024 Fixed</option>
                <option value="2023-fixed">2023 Fixed</option>
              </select>
            </label>
          </div>
        </div>
        <div id="compositeIndexScatterplotChart" class="chart"></div>
        
        <div id="compositeIndexResidualChart" class="chart advanced-only"></div>
        
        <div class="advanced-only">
          <h3 style="margin-top: 30px;">Residual Evolution Over Time</h3>
          <div class="chart-controls">
            <div class="control-row">
              <label>Residual Type
                <select id="residualEvolutionTypeSelect">
                  <option value="cumulative">Cumulative</option>
                  <option value="isolated" selected>Isolated</option>
                </select>
              </label>
            </div>
          </div>
          <div id="compositeIndexResidualEvolutionChart" class="chart"></div>
          <div id="residualEvolutionVarianceTable" style="margin-top: 20px;"></div>
        </div>
        
        <div id="compositeIndexWeightsTable" class="advanced-only" style="margin-top: 20px;"></div>
        
        <div class="advanced-only">
          <h3 style="margin-top: 30px;">Regression Summary (R² and p-values)</h3>
          <div id="regressionSummaryTable"></div>
        </div>
        
        <h3 id="section3" style="margin-top: 40px; margin-bottom: 12px;">Section 3: Policy Factors</h3>
        <h3 style="margin-top: 30px;">Policy Variable vs Excess Mortality</h3>
        <p style="color: var(--text); opacity: 0.8; margin-bottom: 10px;">
          Relationship between policy indicator values and excess mortality
        </p>
        <div class="chart-controls">
          <div class="control-row">
            <label>X-Axis: Policy Variable
              <select id="explanatoryPowerVariableSelect">
                <option value="">Select variable...</option>
              </select>
            </label>
            <label>Year
              <select id="explanatoryPowerPolicyYearSelect">
                <option value="2020" selected>2020</option>
                <option value="2021">2021</option>
                <option value="2020-2021">2020-2021 (Average)</option>
              </select>
            </label>
          </div>
          <div class="control-row">
            <label>Y-Axis: Excess Mortality Year
              <select id="explanatoryPowerYearSelect">
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
              </select>
            </label>
            <label>Type
              <select id="explanatoryPowerTypeSelect">
                <option value="cumulative" selected>Cumulative</option>
                <option value="isolated">Isolated</option>
              </select>
            </label>
          </div>
        </div>
        <div id="explanatoryPowerVariableDescription" style="margin-top: 10px; padding: 10px; background-color: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 0.9em; color: var(--text);">
          <strong>Description:</strong> <span id="explanatoryPowerDescriptionText">—</span>
        </div>
        <div id="policyExplanatoryPowerChart" class="chart"></div>
        <div id="policyExplanatoryPowerTable" style="margin-top: 20px;"></div>
        
        <h3 style="margin-top: 30px;">Policy Variable vs SVI Residuals</h3>
        <p style="color: var(--text); opacity: 0.8; margin-bottom: 10px;">
          Relationship between policy indicator values and residuals from Structural Vulnerability Index regression
        </p>
        <div class="chart-controls">
          <div class="control-row">
            <label>X-Axis: Policy Variable
              <select id="residualExplanatoryPowerVariableSelect">
                <option value="">Select variable...</option>
              </select>
            </label>
            <label>Year
              <select id="residualExplanatoryPowerPolicyYearSelect">
                <option value="NA">NA</option>
                <option value="2020" selected>2020</option>
                <option value="2021">2021</option>
                <option value="2020-2021">2020-2021 (Average)</option>
              </select>
            </label>
          </div>
          <div class="control-row">
            <label>Y-Axis: Excess Mortality Year
              <select id="residualExplanatoryPowerYearSelect">
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
              </select>
            </label>
            <label>Type
              <select id="residualExplanatoryPowerTypeSelect">
                <option value="cumulative" selected>Cumulative</option>
                <option value="isolated">Isolated</option>
              </select>
            </label>
          </div>
        </div>
        <div id="residualExplanatoryPowerVariableDescription" style="margin-top: 10px; padding: 10px; background-color: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 0.9em; color: var(--text);">
          <strong>Description:</strong> <span id="residualExplanatoryPowerDescriptionText">—</span>
        </div>
        <div id="residualExplanatoryPowerChart" class="chart"></div>
        <div id="residualExplanatoryPowerTable" style="margin-top: 20px;"></div>
        
        <h3 id="section4" style="margin-top: 30px;">Section 4: Counterfactuals</h3>
        <div class="chart-controls">
          <div class="control-row" style="align-items: flex-start;">
            <label>Country 1
              <select id="compareCountry1">
                <option value="">Select country...</option>
              </select>
            </label>
            <label>Country 2
              <select id="compareCountry2">
                <option value="">Select country...</option>
              </select>
            </label>
            <label style="flex-direction: column; align-items: flex-start;">
              <span style="margin-bottom: 4px;">Counterfactual Validity</span>
              <select id="counterfactualValidityType" style="margin-bottom: 4px;">
                <option value="2019-asmr">2019 ASMR</option>
                <option value="2025-svi" selected>2025 Structural Vulnerability Index</option>
              </select>
              <div id="counterfactualValidity" style="font-weight: bold; color: var(--text);">—</div>
            </label>
            <label>QALY Multiplier
              <input type="number" id="qalyMultiplier" min="0" max="1" step="0.01" value="1" style="width: 80px;">
            </label>
          </div>
        </div>
        <div id="countryComparisonChart" class="chart"></div>
        <div id="countryComparisonTable" style="margin-top: 20px;"></div>
        
        <h3 style="margin-top: 30px;">Policy Comparison</h3>
        <div class="chart-controls">
          <div class="control-row">
            <label>Policy Variable
              <select id="policyVariableSelect">
                <option value="C1M_School closing" selected>C1M_School closing</option>
              </select>
            </label>
            <button id="calculateAreaRatiosBtn" class="filter-btn" title="Find Policy Similarities">Find Policy Similarities</button>
          </div>
        </div>
        <div id="policyVariableDescription" style="margin-top: 10px; padding: 10px; background-color: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 0.9em; color: var(--text);">
          <strong>Description:</strong> <span id="policyDescriptionText">—</span>
        </div>
        <div id="policyComparisonChart" class="chart"></div>
        <div id="policyAreaRatioTable" style="margin-top: 20px;"></div>
      </div>
    </section>

    <section id="baselineComparison" class="chart-card advanced-only" style="margin-top: 40px;">
      <h2>Baseline Comparison: All Baselines</h2>
      <p style="color: var(--text); opacity: 0.8; margin-bottom: 20px;">
        This section shows residual evolution plots and statistics for all baseline selections using isolated residuals.
      </p>
      <div class="chart-controls">
        <div class="control-row">
          <button id="generateBaselineComparisonBtn" class="filter-btn" title="Generate comparison for all baselines">Generate Baseline Comparison</button>
          <div id="baselineComparisonStatus" style="margin-left: 10px; color: var(--text); opacity: 0.8;"></div>
        </div>
      </div>
      <div id="baselineComparisonGrid" style="display: none;">
        <div style="margin-bottom: 20px;">
          <button id="exportIndividualBaselinesPDFBtn" class="filter-btn" title="Export individual baseline views as PNG" style="display: none;">Export Individual Baselines as PNG</button>
        </div>
        <div id="individualBaselinesDisplay">
        <!-- Grid will be populated by JavaScript -->
        </div>
        <div id="individualBaselinesForExport" style="background: white; color: black; padding: 20px; display: none;">
        <!-- Export version will be populated by JavaScript -->
        </div>
      </div>
      
      <div id="baselineComparisonAggregated" style="display: none; margin-top: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">Aggregated Views</h3>
          <button id="exportAggregatedPDFBtn" class="filter-btn" title="Export aggregated views as PNG" style="display: none;">Export as PNG</button>
        </div>
        
        <div id="aggregatedViewsForExport" style="background: white; color: black; padding: 20px;">
        <h4 style="margin-top: 30px; margin-bottom: 8px;">Regression Summary (R² and p-values) - All Baselines</h4>
        <p style="color: black; font-size: 0.9em; margin-bottom: 15px; margin-top: 0;">
          Factor regressions were taken against the 2025 (01.01.2020-31.12.2024) cumulative excess mortality.
        </p>
        <div id="aggregatedRegressionTable"></div>
        
        <h4 style="margin-top: 30px; margin-bottom: 8px;">Structural Vulnerability Index (SVI - 2025 Fixed) - All Baselines</h4>
        <p style="color: black; font-size: 0.9em; margin-bottom: 15px; margin-top: 0;">
          SVI weights were calculated from a multiregression across known structural factors (2019 ASMR, GDP, Healthcare Expenditure, Inequality, Poverty) against the 2025 (01.01.2020-31.12.2024) cumulative excess mortality for each baseline.
        </p>
        <div id="aggregatedWeightsTable"></div>
        
        <h4 style="margin-top: 30px; margin-bottom: 8px;">Residual Evolution Plots - All Baselines</h4>
        <p style="color: black; font-size: 0.9em; margin-bottom: 15px; margin-top: 0;">
          Residuals are against the trendline formed from yearly excess mortality vs Structural Vulnerability Index (SVI).
        </p>
        <div id="baselinePlotsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <!-- Plots grid will be populated by JavaScript -->
        </div>
        
        <h4 style="margin-top: 30px; margin-bottom: 8px;">Variance of Residuals by Year - All Baselines</h4>
        <p style="color: black; font-size: 0.9em; margin-bottom: 15px; margin-top: 0;">
          Residuals are against the trendline formed from yearly excess mortality vs Structural Vulnerability Index (SVI).
        </p>
        <div id="aggregatedVarianceTable"></div>
        
        <h4 style="margin-top: 30px; margin-bottom: 8px;">Baseline Trend Slopes and Intercepts - All Baselines</h4>
        <p style="color: black; font-size: 0.9em; margin-bottom: 15px; margin-top: 0;">
          Slope and intercept of the linear trend used in the expected mortality baseline for each country and baseline method. Format: slope(intercept).
        </p>
        <div id="aggregatedSlopesTable"></div>
        
        <h4 style="margin-top: 30px; margin-bottom: 8px;">2025 Predicted Value Comparison: RMSE vs Other Baselines</h4>
        <p style="color: black; font-size: 0.9em; margin-bottom: 15px; margin-top: 0;">
          Predicted values at 2025 using slope and intercept from baseline trends. Green indicates RMSE has lower predicted value (better), yellow indicates same, red indicates RMSE has higher predicted value (worse).
        </p>
        <div id="aggregatedVarianceComparisonTable"></div>
        </div>
      </div>
    </section>


    <section id="methods" aria-label="Methods">
      <h3 id="section5" style="margin-top: 0; margin-bottom: 12px;">Section 5: Method Notes</h3>
      <h3>Age-Standardised Mortality Rate</h3>
      <p>Data Source: Short-term Mortality Fluctuations (STMF) by Human Mortality Database. STMF mortality rates have been aggregated to replicate ESP2013 ASMR in the following proportions: 0–14: 0.156, 15–64: 0.654, 65–74: 0.080, 75–84: 0.066, 85+: 0.044.</p>
      
      <h3>Baseline Selection</h3>
      <p>If we treat the pandemic as an equilibrium shock, the optimal baseline predicts the post-shock return to equilibrium. Baselines are derived from the pre-pandemic period that minimises the RMSE to the post-pandemic equilibrium (2025 or 2024 depending on availability). Quasi Poisson Regression has been used in each case. <a href="./data/baselineComparisons.png" target="_blank" class="method-link">This baseline selection method outperforms static ranges on 7 out of 11 metrics.</a></p>
      
      <h3>Structural Vulnerability Index</h3>
      <p>The Structural Vulnerability Index is calculated using multiple regression analysis. A regression model is fitted to predict cumulative excess mortality from five structural factors: 2019 baseline ASMR (STMF-derived), GDP per capita (World Bank), GINI coefficient (World Bank), poverty rate (World Bank), and health expenditure as a percentage of GDP (World Bank). The index is the predicted value from this regression model, providing a composite measure of structural vulnerability that combines all five factors into a single metric.</p>
      
      <h3>Policy Variables: IMF 2021</h3>
      <p>This database summarizes key fiscal measures governments have announced or taken in selected economies in response to the COVID-19 pandemic as of September 27, 2021. 23 out of 36 countries have available data.</p>
      
      <h3>Policy Variables: OxCGRT</h3>
      <p>The Oxford Covid-19 Government Response Tracker (OxCGRT) is a project that collected information on policy measures to tackle COVID-19 over the pandemic. The measures used in this analysis are the average of 2020, 2021, or 2020-2021.</p>
      
      <h3>Counterfactual Validity</h3>
      <p>74% of excess mortality variation can be explained by baseline mortality (2019 ASMR) and 79% can be explained by the Structural Vulnerability Index. Counterfactual validity has been estimated by how similar each countries score is across these two measures. The lower quartile of differences is green, 2nd quartile yellow, 3rd quartile orange, 4th quartile red, representing most to least valid counterfactuals.</p>
    </section>
  </main>

  <footer class="container">
    <p></p>
  </footer>

</body>
</html>
